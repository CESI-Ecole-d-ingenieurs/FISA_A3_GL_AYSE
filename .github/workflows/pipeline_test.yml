name: CI - Tests & Analyse EasySave

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  test:
    name: Vérifications & Tests
    runs-on: windows-latest

    steps:
      - name: Checkout du code
        uses: actions/checkout@v3

      - name: Installation de .NET 8
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Installation de .NET Framework 4.7.2 via Chocolatey
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force
          [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
          Invoke-WebRequest -Uri https://community.chocolatey.org/install.ps1 -UseBasicParsing | Invoke-Expression
          choco install netfx-4.7.2-devpack -y
        shell: powershell

      - name: Vérifier le répertoire courant
        run: Get-Location
        shell: pwsh

      - name: Nettoyage des anciennes références
        run: dotnet clean

      - name: Supprimer les fichiers de build précédents
        run: |
          if (Test-Path bin) { Remove-Item -Recurse -Force bin }
          if (Test-Path obj) { Remove-Item -Recurse -Force obj }
        shell: pwsh

      - name: Restauration des dépendances
        run: dotnet restore --packages ${{ github.workspace }}/.nuget/packages

      - name: Définir le chemin des packages NuGet
        run: echo "NUGET_PACKAGES=${{ github.workspace }}/.nuget/packages" >> $GITHUB_ENV

      - name: Afficher les chemins NuGet
        run: dotnet nuget locals all --list

      - name: Vérifier si Newtonsoft.Json est installé
        run: ls ${{ github.workspace }}/.nuget/packages/newtonsoft.json || echo "Newtonsoft.Json NON TROUVÉ"

      - name: Vérifier les fichiers projet
        run: Get-ChildItem -Path ${{ github.workspace }} -Filter "*.csproj" -Recurse
        shell: pwsh

      - name: Installation manuelle de Newtonsoft.Json
        run: |
          cd ${{ github.workspace }}/EasySave.Logger
          dotnet add package Newtonsoft.Json --version 13.0.3
        shell: pwsh

      - name: Vérification des packages installés
        run: dotnet list package
        shell: pwsh

      - name: Compilation du projet
        run: dotnet build --configuration Release --no-restore
        shell: pwsh

      - name: Exécution des tests unitaires avec couverture de code
        run: dotnet test --configuration Release --no-restore --verbosity normal --collect:"XPlat Code Coverage"
